---
output: 
  pdf_document:
    includes:
      before_body: Portada.tex
      in_header: 
    toc: true
    toc_depth: 3
  tables: true
include-before:
- '`\newpage{}`{=latex}'
toc-title: Contenido
urlcolor: blue
header-includes:
- \usepackage[nottoc]{tocbibind}
- \renewcommand{\listfigurename}{Lista de figuras}
- \renewcommand{\listtablename}{Lista de tablas}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{lscape}
- \usepackage{amsmath}
---

\newpage

\listoffigures

\listoftables

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align="center", fig.pos = "H", fig.width = 7, fig.height = 3)
```

\newpage

# Preguntas teóricas
**Resuelva los ejercicios 8.1, 8.2, 8.4, 8.5 y 8.6, (Romer, 5a Ed). Realice estos con ayuda de su laboratorista y entregue las soluciones a máquina, utilizando LaTeX.**

## Ejercicio 8.1, Romer (5ta Edicion)

\begin{enumerate}
\item[] \textbf{8.1} Life-cycle saving. (Modigliani and Brumberg, 1954.) Consider an individual who lives from 0 to T, and whose lifetime utility is given by $U= \int_{t=0}^{T} u(C(t))\,dt$, where $ u'(\cdot)>0$, $u''(\cdot)<0$. The individual’s income is $ Y_{0}+gt$ for $ 0 \le t < R$, and $0$ forn $ R \le t \le T$. The retirement age, $R$, satisfies $0<R<T$. The interest rate is zero, the individual has no initial wealth, and there is no uncertainty.
\end{enumerate}

### Ejercicio (a)
\begin{enumerate}
\item[] \textit{a. What is the individual’s lifetime budget constraint?}
\end{enumerate}

### Ejercicio (b)
\begin{enumerate}
\item[] \textit{b. What is the individual’s utility-maximizing path of consumption, $C(t)$?}
\end{enumerate}

### Ejercicio (c)
\begin{enumerate}
\item[] \textit{c. What is the path of the individual’s wealth as a function of $t$?}
\end{enumerate}

## Ejercicio 8.2, Romer (5ta Edicion)
\begin{enumerate}
\item[] \textbf{8.2} The average income of farmers is less than the average income of non-farmers, but fluctuates more from year to year. Given this, how does the permanent-income hypothesis predict that estimated consumption functions for farmers and nonfarmers differ?
\end{enumerate}

De los supuestos que proporciona Milton Friedman para su Hipótesis del Ingreso Permanente se deducen los siguientes parámetros para un modelo de regresión lineal que busca explicar el consumo $C_i = a + bY_i + u_i$:

$$
\hat{b}=\frac{var(Y^P)}{var(Y^P)+var(Y^T)} \qquad \text{y} \qquad \hat{a}=(1-\hat{b})\bar{Y^P}
$$

en donde $Y^P$ representa el ingreso permanente, $Y^T$ el ingreso transitorio (i.e. $Y_t - \frac{1}{T}\sum{Y_t}$) y $\bar{Y^P}$ el ingreso permanente promedio. 


Sabemos que el ingreso transitorio de los agricultores presenta mayor fluctuación que el ingreso transitorio de los no agricultores, por lo que $var(Y^T)_A > var(Y^T)_{NA}$. También conocemos el hecho de que $\bar{Y^P}_A < \bar{Y^P}_{NA}$.

Suponiendo que $var(Y^P)$ es la misma para ambos grupos, se tiene entonces que $\hat{b}_A<\hat{b}_{NA}$. Esto implica que, en tal modelo, la pendiente del grupo no agricultor es mayor y, por tanto, que un cambio en el ingreso de ambos grupos de la misma magnitud afecta más al consumo de los no agricultores. Por otra parte, en el parámetro $\hat{a}$ se tienen dos efectos que se contraponen: $1-\hat{b}_A > 1-\hat{b}_{NA} \quad \text{y} \quad \bar{Y^P}_A<\bar{Y^P}_{NA}$, y no está claro que la ordenada para cierto grupo sea mayor, menor, o igual que la del otro.

Además, recordemos que un aumento en el ingreso incrementará el consumo solo en la medida en que aumenta el ingreso permanente. Cuando $\Delta Y^P$ es pequeño en relación con $\Delta Y^T$, poco del cambio en el ingreso $\Delta Y$ proviene del cambio en el ingreso permanente y, en consecuencia, el cambio en el consumo será menor. En el caso de los agricultores, $\Delta Y^T_A>\Delta Y^T_A$, por lo que el consumo no varía tanto en relación a $\Delta Y_A$ en comparación con los no agricultores.

## Ejercicio 8.4, Romer (5ta Edicion)
\begin{enumerate}
\item[] \textbf{8.4} In the model of Section 8.2, uncertainty about future income does not affect consumption.
Does this mean that the uncertainty does not affect expected lifetime utility?
\end{enumerate}

En esta sección se asume una forma funcional cuadrática de la utilidad. Pdemos escribir las siguientes funciones para describir el caso con certidumbre y el caso con incertidumbre, respectivamente:

$$
U = \sum_{0}^{T}(C_t-\frac{a}{2}C_t^2) \quad \text{y} \quad E[U] = E \left[ \sum_{0}^{T}(C_t-\frac{a}{2}C_t^2) \right ]
$$
Para el caso con incertidumbre, se tienen una serie de elementos y supuestos que son fundamentales para el análisis, a saber:

1. El agente espera consumir en el periodo $t$ lo mismo que consumió en el periodo 1: $C_1 = E_1[C_t]$.
2. El paso aleatorio, $e_t$, tiene una medio igual cero: $E_{k}[e_{t}] = 0 \quad \forall t,k<t$.
3. La hipótesis del ingreso permanente implica que el consumo sigue una caminata aleatoria: $C_t = C_{t-1}+e_t$

Supongamos que nos encontramos en en el periodo $t-1$ y por tanto conocemos lo que pasa en tal periodo ($E_{t-1}[C_{t-1}] = C_{t-1}$ i.e. el consumo en $t-1$ ya se sabe y opera como una constante). Incorporando los resultados anteriores en la ecuación que representa la incertidumbre, obtenemos:


\begin{equation*} 
\begin{split}
E[U]  &=  E \left [ \sum_{1}^{T}(C_t-\frac{a}{2}C_t^2) \right ] \\
      &=  E \left [ \sum_{1}^{T}(C_{t-1}+e_t-\frac{a}{2}(C_{t-1}+e_t)^2 \right ] \\
      &= E \left [ \sum_{1}^{T}(C_{t-1}+e_t-\frac{a}{2}(C_{t-1}^2+2C_{t-1}e_t+e_t^2) \right ] \\
      &=  \sum_{1}^{T} \left [E[C_{t-1}]+E[e_t]-\frac{a}{2}(E[C_{t-1}^2]+2E[C_{t-1}e_t]+E[e_t^2]) \right ]\\
      &=  \sum_{1}^{T} \left [C_{t-1}+E[e_t]-\frac{a}{2}(E[C_{t-1}^2]+2C_{t-1}E[e_t]+var[e_t]+E[e_t]^2) \right ] \\
      &=  \sum_{1}^{T} \left [C_{t-1}-\frac{a}{2}(C_{t-1}^2+var[e_t]) \right ]
\end{split}
\end{equation*}


Como $var[e_t] \geq 0$, notemos que el la utilidad de por vida del agente resulta mayor en el caso con certidumbre que bajo incertidumbre, ya que a esta última se le está restando el término $\frac{a}{2}var[e_t]$. Es decir:
$$
E[U] = \sum_{1}^{T} \left [C_{t-1}-\frac{a}{2}(C_{t-1}^2+var[e_t]) \right ] \leq \sum_{0}^{T}(C_{t-1}-\frac{a}{2}C_{t-1}^2) = U
$$


Por lo tanto, la incorporación de incertidumbre **sí** afecta a la utilidad esperada de toda la vida.

## Ejercicio 8.5, Romer (5ta Edicion)
\begin{enumerate}
\item[] \textbf{8.5} (This follows Hansen and Singleton, 1983.) Suppose instantaneous utility is of the
constant-relative-risk-aversion form, $u(C_{t})= \frac{C_{t}^{1- \theta}}{1- \theta}$, $ \theta >0 $. Assume that the real interest rate, $r$ , is constant but not necessarily equal to the discount rate, $\rho$.
\end{enumerate}

### Ejercicio (a)
\begin{enumerate}
\item[] \textit{a. Find the Euler equation relating $C_{t}$ to expectations concerning $C_{t +1}$.}
\end{enumerate}

Consideremos los dos periodos $t$ y $t+1$. Luego, la función de utilidad esperada puede escribirse como:

$$
U(C_t,C_{t+1}) = u(C_t)+\frac{1}{1+\rho}E[u(C_{t+1})]=
\frac{C_t^{1-\theta}}{1-\theta}+\frac{1}{(1-\rho)(1-\theta)}E[C_{t+1}^{1-\theta}]
$$

En general, la restricción presupuestaria está dada por:

$$
E[C_{t+1}]=(1+t)w+(1+r)C_t
$$

en donde $w$ (por *wealth*) incorpora la riqueza que existirá en $t+1$. Como puede observarse, la pendiente de la restricción es $1+r$. O sea, renunciar a una unidad de consumo hoy me permite consumir $1+r$ unidades mañana.

Siguiendo el análisis tradicional de las condiciones de maximización, tenemos que en el óptimo la relación marginal de sustitución (i.e. el ratio de la utilidad de hoy a la que se espera mañana) es igual a la pendiente de la restricción presupuestaria:

$$
 \frac{ \partial U(\cdot)}{ \partial C_t}=C^{-\theta}_t \quad \text{y} \quad \frac{ \partial  U(\cdot)}{ \partial C_{t+1}}=\frac{E[C^{-\theta}_{t+1}]}{1-\rho}.
$$
Así, si el agente está optimizando:

$$
 \frac{(1-\rho)C^{-\theta}_t}{E[C^{-\theta}_t]} = 1+r \quad \iff \quad C^{-\theta}_t=\left ( \frac{1+r}{1+\rho} \right)E[C^{-\theta}_{t+1}].
$$

### Ejercicio (b)
\begin{enumerate}
\item[] \textit{b. Suppose that the log of income is distributed normally, and that as a result the log of $C_{t+1}$ is distributed normally; let $\sigma^{2}$ denote its variance conditional on information available at time $t$. Rewrite the expression in part (a) in terms of $ln C_{t}$ , $ \mathbb{E}_{t}[lnC_{t+1}]$, $\sigma^{2}$, and the parameters $r$ , $\rho$, and $\theta$ . (Hint: If a variable $x$ is distributed normally with mean $\mu$ and variance $V$, $\mathbb{E}[e^{x}] = e^{\mu} e^{V/2}$.)}
\end{enumerate}


Tenemos que $lnC_{t+1} \sim N(E[lnC_{t+1}],\sigma^2)$. Reescribiendo la escuación obtenida anteriormente, podemos hacer las siguientes deducciones:


\begin{equation*} 
\begin{split}
-\theta ln C_t  &=  ln \left [ \frac{1+r}{1+\rho}E[C^{-\theta}_{t+1}] \right ] \\
      &=  ln(1+r)-ln(1+\rho)+lnE[C^{-\theta}_{t+1}] \\
      &=  ln(1+r)-ln(1+\rho)+lnE[e^{-\theta lnC_{t+1}}]\\
      &=  ln(1+r)-ln(1+\rho)+ln[e^{-\theta E(lnC_{t+1})}e^{\sigma^2/2}] \\
      &= ln(1+r)-ln(1+\rho)-\theta E[C_{t+1}] + \sigma^2/2 \\
lnC_t &= \frac{ln(1+ \rho)-ln(1+r)}{\theta} + E[C_{t+1}] - \frac{\sigma^2}{2\theta}
\end{split}
\end{equation*}

### Ejercicio (c)
\begin{enumerate}
\item[] \textit{c. Show that if $r$ and $\sigma^{2}$ are constant over time, the result in part (b) implies that the log of consumption follows a random walk with drift: $lnC_{t+1} = a + lnC_{t} + u_{t+1}$, where $u$ is white noise.}
\end{enumerate}

De la anterior ecuación podemos despejar $E[lnC_{t+1}]$:
$$
E[lnC_{t+1}] = lnC_t + \frac{ln(1+r)-ln(1+ \rho)}{\theta} + \frac{\sigma^2}{2\theta}
$$
Obsérvese que el (log del) consumo esperado en el siguiente periodo es igual al (log del) consumo de hoy **màs** una constante que no puede predecirse. Definamos tal constante como $a=\frac{ln(1+r)-ln(1+ \rho)}{\theta} + \frac{\sigma^2}{2\theta}$. Así, podemos escribir:

$$
E[lnC_{t+1}] = a + lnC_t + u_t.
$$

### Ejercicio (d)
\begin{enumerate}
\item[] \textit{d. How do changes in each of $r$ and $\sigma^{2}$ affect expected consumption growth, $ \mathbb{E}_{t}[lnC_{t+1}-lnC_{t}]$? Interpret the effect of $\sigma^{2}$ on expected consumption growth in light of the discussion of precautionary saving in Section 8.6.}
\end{enumerate}

Nuevamente, podemos reacomodar la ecuación obtenida anteriormente (nota: $C_t$ es conocido y además el operador esperanza es lineal):

$$
E[lnC_{t+1}-lnC_t] + \frac{ln(1+r)-ln(1+ \rho)}{\theta} + \frac{\sigma^2}{2\theta}
$$
El cambio esperado en el consumo puede analizarse mediante las derivadas parciales:

$$
\frac{\partial E(\cdot)}{ \partial r} = \frac{1}{\theta(1+r)}>0 \quad \text{y} \quad \frac{\partial E(\cdot)}{ \partial \sigma^2} = \frac{1}{2\theta}>0.
$$
Con estos resultados puede concluirse que un aumento (infinitesimal) de la tasa de interés incrementará el crecimiento esperado del consumo. Por otra parte, un aumento en la varianza (incertidumbre) aumentará el crecimiento esperado del consumo (y con ello el ahorro). Lo anterior implica que el agente ahorra precautoriamente, y se deriva de una función de utilidad con Aversión Relativa al Riesgo Constante (CRRA).

## Ejercicio 8.6, Romer (5ta Edicion)
\begin{enumerate}
\item[] \textbf{8.6} A framework for investigating excess smoothness. Suppose that $C_{t}$ equals $ \left( \frac{r}{1 + r} \right) \left (A_{t} + \sum_{s=0}^{\infty} \frac {\mathbb{E}[Y_{t+s}]}{(1+r)^{s}} \right)$.
\end{enumerate}

### Ejercicio (a)
\begin{enumerate}
\item[] \textit{a. Show that these assumptions imply that $\mathbb{E}_{t}[C_{t +1}]=C_{t}$ (and thus that consumption follows a random walk) and that $ \sum_{s=0}^{\infty}\frac {\mathbb{E}[C_{t+s}]}{(1+r)^{s}}=A_{t} + \sum_{s=0}^{\infty} \frac {\mathbb{E}[Y_{t+s}]}{(1+r)^{s}}$.}
\end{enumerate}

### Ejercicio (b)
\begin{enumerate}
\item[] \textit{b. Suppose that $\Delta Y_{t} = \phi \Delta Y_{t-1}+u_{t}$, where $u$ is white noise. Suppose that $Y_{t}$ exceeds $\mathbb{E}_{t-1}[Y_{t}]$ by $1$ unit (that is, suppose $u_{t} = 1$). By how much does consumption increase?}
\end{enumerate}

### Ejercicio (c)
\begin{enumerate}
\item[] \textit{c. For the case of $\phi>0$, which has a larger variance, the innovation in income, $u_{t}$, or the innovation in consumption, $C_{t} - \mathbb{E}_{t-1}[C_{t}]$? Do consumers use saving and borrowing to smooth the path of consumption relative to income in this model? Explain.}
\end{enumerate}

```{r}
pacman::p_load(tidyverse,
               ggthemes,
               haven, readxl,
               kableExtra,
               cowplot, ggplot2, scales, viridis, latticeExtra,
               knitr, tinytex, reshape, lubridate, scales, reshape2)


set.seed(1000) #Utilizamos una semilla para poder replicar los experimentos. 
```
## Ejercicio 2
**2. Simule una variedad de agentes que tienen ingresos permanentes diferentes e ingresos transitorios diferentes y calcule la relación entre consumo e ingreso que resulta dada una variedad de supuestos para las varianzas de cada tipo de ingreso siguiendo estos pasos:**


### (a) 

**Cree un vector de 20 ingresos permanentes aleatorios $Y_i^P$, distribuidos normalmente, con media 10 y varianza $\sigma^{P}$. Cree 20 vectores (cada uno de estos vectores representa una persona) cada uno con 100 observaciones idénticas del ingreso permanente. Grafíquelos (eje x, persona; eje y, ingreso permanente).**

```{r, echo=FALSE}

Y_p <- list()
for(i in 1:20){
  Y_p[[i]] <- rnorm(1:100, mean=10)
} 

df_yp <- data.frame(t(matrix(unlist(Y_p), nrow=length(Y_p), byrow=TRUE))) #I para cada individuo.
  for(i in 1:20){
    names(df_yp)[i] <- paste("I", i, sep= "")
  }

boxplot(df_yp, xlab="Personas", ylab="Ingreso permamente")

```
### (b) 

**Cree 20 vectores de 100 ingresos transitorios aleatorios $Y_{i,t}^{T}$, distribuidos normalmente, con media 0 y con varianza $\sigma^{T}$. Grafíquelos.**

```{r, echo=FALSE}

Y_t <- list()
for(i in 1:20){
  Y_t[[i]] <- rnorm(1:100, mean=0)
} 

df_yt <- data.frame(t(matrix(unlist(Y_t), nrow=length(Y_t), byrow=TRUE))) #I para cada individuo.
  for(i in 1:20){
    names(df_yt)[i] <- paste("I", i, sep= "")
  }
boxplot(df_yt, xlab="Personas", ylab="Ingreso transitorio")

```

### (c) 

**Cree 20 vectores de 100 ingresos totales $Y_{i,t}$, sumando el ingreso transitorio y el permanente. Grafíquelos.**
```{r, echo=TRUE}
df_YT <- df_yp+df_yt
boxplot(df_YT, xlab="Personas", ylab="Ingreso total")
```

### (d) 

**Cree 20 vectores de 100 errores de medición $\epsilon_{i,t}$, distribuidos normalmente, con media 0 y varianza $\sigma^{\epsilon}>0$. Grafíquelos.**
```{r, echo=FALSE}
e <- list()
for(i in 1:20){
  e[[i]] <- rnorm(1:100, mean=0)
} 

df_e <- data.frame(t(matrix(unlist(e), nrow=length(e), byrow=TRUE))) #I para cada individuo.
  for(i in 1:20){
    names(df_e)[i] <- paste("I", i, sep= "")
  }
boxplot(df_e, xlab="Personas", ylab="Ingreso transitorio")

```

### (e) 

**Cree  20 vectores de 100 consumos $C_{i,t}$ cada uno, de acuerdo a la siguiente regla $C_{i,t}=Y_{i}^{P}+0.1Y_{i,t}^{T}+\epsilon_{i,t}$. Grafíquelos.**

```{r, echo=TRUE}
df_c <- df_yp + (0.1*df_yt) + df_e

boxplot(df_c, xlab="Personas", ylab="Consumo")

```
### (f) 

**Estime la relación lineal entre ingreso total y consumo $C_{i,t}=\alpha+\beta Y_{i,t}+\epsilon_{i,t}$. Describa el resultado de su estimación y grafíque la relación entre las observaciones del consumo y las del ingreso.**
```{r,echo=FALSE}
x <- 1:20
x <- t(as.data.frame(x))
df_ytt <- t(df_yt)

```

### (g) 

**Incremente la varianza del ingreso permanente, y disminuya la varianza del ingreso transitorio y vuelva a estimar y graficar la relación entre el consumo y el ingreso.**


### (h) 

**Disminuya la varianza del ingreso permanente, y aumente la varianza del ingreso transitorio y vuelva a estimar y graficar la relación entre el consumo y el ingreso.**


## Ejercicio 3
**3. Estudie el consumo agregado en México siguiendo estos pasos:**


### (a) 

**Obtenga, del Inegi, datos de ``C'', el consumo agregado en México, de ``Y'', el producto agregado, de ``I'', la inversión agregada, de ``G'', el gasto del gobierno y de , de ``NX'', las exportaciones netas,  entre 1980 y el tercer trimestre de 2019, EN TÉRMINOS REALES.**


### (b) 

**Grafíque dichas serie de tiempo juntas para comparalas visualmente.  (Compare la gráfica de las variables (de las que son siempre positivas) en dos versiones: a) su valor real original, y b) después de sacarles el logaritmo natural).**


### (c) 

**Grafique también la tasa de crecimiento, $\% \Delta a_t = (a_t-a_{t-1})/a_{t-1}$,  de todas estas series.**


### (d) 

**Enfóquese ahora nada más al consumo y al producto agregado. Grafique la relación entre una serie y la otra, es decir, grafique los puntos $(\% \Delta Y_t,\% \Delta C_t)$ poniendo el consumo en las ordenadas.**


### (e) 

**Calcule la volatilidad de las dos series de tasas de crecimiento. ¿Qué es más volatil, el ingreso o el consumo?**


### (f) 

**Estime cuatro modelos lineales: $C_t=a+bY_t+\epsilon_t$, $\Delta\%C_t=a+b \Delta\%Y_t+\epsilon_t$, $\Delta\%C_t=a+b \Delta\%Y_{t-1}+\epsilon_t$ y $c_t=a+by_t+\epsilon_t$, donde las minúsculas reflejan el logaritmo de la variable en mayúscula, y reporte los valores estimados de los coeficientes, los estadísticos T, las R cuadradas, etc.**


### (g) 

**Explique qué se podría concluir, si fuera el caso, a cerca de la Hipótesis de Ingreso Permanente para México a partir de los coeficientes encontrados.**


## Ejercicio 4
**4. Estudie el consumo de los individuos en México, siguiendo estos pasos:**


### (a) 

**Baje los datos de un año de la ENIGH del sitio del INEGI, (Cada grupo va a utilizar unos datos diferentes: Grupo 1-2020, Grupo 2-2018, Grupo 3-2016, ..., etc.)  y establezca el número de hogares y el ingreso y el gasto promedio.**


### (b) 

**Estime una relación entre ingreso y gasto y reporte sus resultados.**


### (c) 

**Estime una relación entre ingreso y gasto pero para hogares unipersonales de edad entre 30 y 40 años de edad de la Ciudad de México.**


### (d) 

**Para todos los hogares unipersonales, estime el valor promedio del ingreso por edad, separando la muestra en grupos de edad de cinco años cada uno y grafíquelo.**


### (e) 

**Interprete sus resultados a la luz de la HIP y comparados con los resultados para las variablea agregadas.**


## Ejercicio 5
**5. Estudie el ``acertijo del premio al riesgo'' para el caso de México siguiendo estos pasos:**


### (a) 

**Consiga los valores anuales de IPC, el Indice de Precios y Cotizaciones de la Bolsa Mexicana de Valores por lo menos desde 1990.**


### (b) 

**Calcule su tasa de retorno nominal para cada año.**


### (c) 

**Consiga los valores promedio anual de la tasa de interés de CETES a 7 días, o la TIIE, la tasa inter-bancaria de equilibrio, y de la tasa de interés a un año, para el periodo que esté disponible.**


### (d) 

**Calcule la diferencia entre el retorno del IPC y el retorno de invertir en CETES a distintos plazos.**


### (e) 

**Calcule la covarianza entre dicha diferencias y  la tasa de crecimiento real del consumo agregado de la economía mexicana.**


### (f) 

**Calcule el valor de aversión relativa al riesgo que implican estos números, dado el supuesto de una utilidad con forma ARRC.**


### (g) 

**Ahora calcule la covarianza entre dicha diferencias y  la tasa de crecimiento real del consumo agregado DE BIENES IMPORTADOS [aquí hay una serie: www.inegi.org.mx/temas/imcp/] de la economía mexicana.**


### (h) 

**Calcule el valor de aversión relativa al riesgo que implican estos números, dado el supuesto de una utilidad con forma ARRC.**


### (i) 

**Interprete sus resultados.**


## Ejercicio 6
**6. Utilice el método del árbol binomial para, primero, explicar el precio P=80 de un activo y, después, valuar un "call" sobre dicho activo, con precio de ejercicio K=P-N donde N es el número de su equipo, (Grupo 1, use N=1, Grupo 2, use N=2, etc) asumiendo una tasa de interés de 5 por ciento:**

Resulta intuitivo representar el problema de la valuación de opciones mediante un "árbol" en donde se consideran distintos escenarios. En la siguiente figura, el primer nodo del árbol izquierdo contempla el precio actual del activo subyacente, el cual puede ser una acción, commodity, metal, entre otros. Los siguientes nodos representan los dos valores que puede tomar tal activo en el siguiente periodo, $t=1$, es decir, los posibles estados de la naturaleza. En particular, el activo puede subir de precio (apreciarse) o bajar de precio (depreciarse). 

```{r echo=F, fig.cap= "Representación del Modelo Binomial", fig.pos='H'}
imagen1 <- ggdraw() + draw_image("general.png", scale=0.9)
imagen1
```
Por otra parte, el árbol de la derecha representa los pagos de la opción en ambos estados de la naturaleza. Es importante notar que si el activo subyacente se deprecia, entonces no se ejerce la opción, por lo que el pago de la opción será igual a cero y la pérdida consistirá en el precio que pagó el inversionista para ser acreedor de tal opción.  Si la opción se ejerce, el pago que se recibe es $D_1(+)=S_1(+)-K=S_1(+)-79$, en donde $K=S_0-1$ (porque éste es el equipo 1). El tema de interés es, justamente, obtener un valor confiable que nos diga cuál debería ser ese precio de entrada (o precio de la opción), dado que se contemplan dos estados de la naturaleza. En otras palabras, queremos calcular el valor de $D_0$.

El pago que brinda la opción puede resumirse mediante las siguientes ecuaciones, en las cuales suponemos que $S_1(+)>S_1(-)$:

$$
D_1(+) = max\{0, S_1(+)-K\} = max\{0,S_1(+)-79\}= S_1(+)-79. \\
$$
$$
D_1(-) = max\{0, S_1(-)-K\} = max\{0,S_1(-)-79\}=0.
$$

en donde $S_1(+)$ representa el precio del activo subyacente en el estado de la naturaleza en donde se aprecia, $S_1(-)$ representa el precio del subyacente en el estado de la naturaleza en que se deprecia. 

En este ejercicio consideraremos una serie de valores que representan una apreciación y otra en donde el subyacente se deprecia con el objetivo de observar más detalladamente el precio de la opción.

```{r}
#Generemos un conjunto de precios números aleatorios para representar los posibles valores del activo en el siguiente periodo.
set.seed(20)
pos <- floor(runif(20, min=81, max=110))
neg <- floor(runif(20, min=50, max=79))

#Nota: se fijó una semilla al inicio del ejercicio 2, lo que permitirá la replicabilidad.

```


Resulta conveniente incorporar en este ejercicio el uso de una "técnica de arbitraje", apodada *Delta Hedging*. Tal técnica involucra *cubrir* la opción (*hedge the option*) con el activo suficiente para generar un portafolio libre de riesgo. Entonces, el portafolio consistirá en una proporción que se invierte en el activo subyacente, denotada por $\Delta$ y en una posición en una opción *call*:
$$
V_t = \Delta S_t - D_t
$$
en donde $V_t$ es el valor del portafolio en el tiempo $t$. Para que tal estrategia sea libre de riesgo, debe valer lo mismo en $t=1$ bajo todo estado de la naturaleza. Por tanto, tenemos la siguiente identidad:

$$
\Delta S_1(+)-D_1(+)=\Delta S_1(-)-D_1(-)
\iff 
\Delta^*=\frac{S_1(+)-79}{S_1(+)-S_1(-)}.
$$

Obtuvimos un valor de $\Delta$ que permite que el valor del portafolio en el periodo $t=1$ sea el mismo sin importar si le va bien o mal al activo subyacente. Es decir:

$$
\text{Apreciación:} \quad V_{1A}=\Delta^* S_1(+)-D_1(+) = \left ( \frac{S_1(+)-79}{S_1(+)-S_1(-)} \right ) S_1(+)-(S_1(+)-79)
$$
$$
\text{Depreciación:} \quad V_{1D}=\Delta^* S_1(-)-D_1(-) = \left ( \frac{S_1(+)-79}{S_1(+)-S_1(-)} \right ) S_1(-)
$$
Notar que si consideramos, por ejemplo, $S_1(+)=106$. $S_1(-)=64$, entonces $\Delta^* = 27/42=0.642$.Luego, tenemos:

$$
 V_{1A} = V_{1D} = \alpha^*
$$
En donde $\alpha^*$ denota el valor del portafolio en el siguiente periodo. Siguiendo el ejemplo ilustrativo, si se consideran los precios $S_1(+)=106$ y $S_1(-)=64$, tendríamos:
$$
 V_{1A}= \Delta^* S_1(+)-D_1(+) = \left ( \frac{S_1(+)-79}{S_1(+)-S_1(-)} \right )S_1(+)-(S_1(+)-79) = (0.6428)(106)-27= \textbf{41.14}.
$$
$$
 \text{y} \quad V_{1D}= \Delta^* S_1(-)-D_1(-) = \left ( \frac{S_1(+)-79}{S_1(+)-S_1(-)} \right )S_1(-) = (0.6428)(64)-0= \textbf{41.14}.
$$
El valor del portafolio en el siguiente periodo (no importa la unidad: puede ser 1 día, 1 mes, 1 año, 1 década) valdrá, con toda probabilidad, $\alpha^*$ (i.e. $Prob(V_1=\alpha^*)=1$). En efecto, las condiciones arriba mencionadas se cumplen y, a estos precios, $Prob(V_1=41.14)=1$.


```{r}
#Construimos un data frame en donde se consideren ambos escenarios.

states <- data.frame("Apreciación"=pos,"Depreciación"=neg)
apr <- states[,1]
dpr <- states[,2]

states <- mutate(states, delta = (apr-79)/(apr-dpr))

#Valor del portafolio con certidumbre
dlt <- states[,3]

states <- mutate(states, valor_t1 = dlt*apr-(apr-79))

```

Ahora bien, el valor del portafolio en el periodo inicial puede verse como el valor del portafolio en el siguiente periodo *descontado* por una tasa de interés libre de riesgo, que en este caso es del 5\%.

$$
V_0 = \frac{V_1}{1+r} \iff \Delta^*S_0-D_0=\frac{\alpha^*}{1.05} \iff D_0^*= \Delta^*80- \frac{\alpha^*}{1.05}
$$
En donde $D_0^*$ es el precio que debe tener la opción, dados los estados de la naturaleza. Por ejemplo, para el escenario en que el precio del subyacente pudiera subir a 106, o bien caer a 64, el precio de la opción sería igual a:

$$
D_0^*=(0.6428)(80)-\frac{41.14}{1.05}= \textbf{12.24}.
$$
Resumamos lo anterior en una tabla en donde se consideran 20 escenarios.

```{r}
states <- mutate(states, prima = (dlt*80)-(valor_t1/1.05))
states <- mutate(states, escenario = c(1:20))
escenario <- states[,6]

names(states) <- c("Apreciación","Depreciación","Delta","Valor en t=1","Precio de la opción","Escenario")

states <- states %>% relocate(Escenario, .before="Apreciación")

knitr::kable(
  states, booktabs = TRUE, align = "c",format = 'latex', digits = 2,
  caption = "Precio de la opción para 20 escenarios"
)%>%
  kable_styling(latex_options = "HOLD_position")

```

```{r echo=F, fig.cap= "Representación gráfica del modelo para el escenario 1"}
imagen2 <- ggdraw() + draw_image("ejerc.png", scale=0.9)
imagen2
```


